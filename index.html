<!DOCTYPE html>
<html>
<meta charset="utf-8">
<title>Strata</title>
<link href="http://fonts.googleapis.com/css?family=ABeeZee|Inconsolata|Karla:400,700|Oxygen+Mono" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=Sorts+Mill+Goudy">
<link rel="stylesheet" type="text/css" href="css/syntax.css">
<link rel="stylesheet" type="text/css" href="css/strata.css">
<body><a href="https://github.com/bigeasy/strata/"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_left_gray_6d6d6d.png" alt="Fork me on GitHub"></a><div class="container">

<div class="unit welcome">
<h1>Strata</h1>
</div>

<div class="unit description markdown"><p>An Evented I/O B-tree for Node.js.</p>
<p>The docs below are a work in progress; for now, <a href="http://bigeasy.github.io/strata/strata.js.html">read the
Docco</a>.</p>
<p>Read the <a href="http://bigeasy.github.io/strata/strata.js.html">Docco</a>! Read the
<a href="http://bigeasy.github.io/strata/strata.js.html">Docco</a>! Read the
<a href="http://bigeasy.github.io/strata/strata.js.html">Docco</a>!</p>
<h2>Purpose</h2>
<p>Strata is part of a collection of database primitives that you can use to design
your own distributed databases for your Node.js applications.</p>
<p>Strata is a <strong>concurrent</strong>, <strong>b‑tree</strong> <strong>primitive</strong>, in
<strong>pure-JavaScript</strong> for Node.js.</p>
<p>A <strong>b‑tree</strong> is a data structure used by databases to store records
organized in large pages on disk.</p>
<p>By <strong>concurrent</strong> I mean that multiple queries can make progress on a descent of
the b‑tree. Multiple reads can all navigate the b‑tree
simultaneously, of course. Multiple reads can also make progress in the presence
of a write, so long as they are not reading a page that is being written. This
is the equivalence to &quot;threading&quot; in other database engines, but evented for
Node.js.</p>
<p>Strata is a database <strong>primitive</strong>, it is not supposed to be used a as a general
purpose database by it&#39;s lonesome, but an interface to a b‑tree and it&#39;s
concepts that you can use to create different types database strategies.</p>
<h3>Brace Yourself</h3>
<p>The interface to Strata is <em>not</em> an API, it is a programmer&#39;s interface to
b‑tree concepts. It is easy to use, if you know how a b‑tree works,
but please don&#39;t complain about encapsulation; it is not a database engine, it
is a b‑tree structure and the <em>details are supposed to be exposed</em>.</p>
<p>The Strata b‑tree interface describes a b‑tree as a collection of
actors, not a collection of objects. A b‑tree isn&#39;t all about &quot;pages.&quot;
It&#39;s about descending, navigating, appending, and balancing a tree. When you
read the code, you&#39;re going to find these people-named classes who do things.</p>
<p>Finally, Strata is an ancient project of mine, that began before I really know
how a Node.js library is supposed to look, so I used closure based objects,
which is a way to go, but most noders use prototype based objects. That&#39;s what
I&#39;d do I was to do it all over again, or maybe not; because I like the way the
code turned out.</p>
<p>I&#39;m going to cut this whinging in the final <code>README.md</code>. It&#39;s here to vent my
defensiveness and remind of who my audience is; people who are experimenting
with their own database structure for their own domain-specific database.</p>
<h3>A Note on Examples</h3>
<p>All of the examples below assume the following function.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">validator</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">forward</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="nx">forward</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">__slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</code></pre>
<p>TK: More about how that works. It&#39;s all over Strata.</p>
<h2>Installing</h2>
<p>Install from NPM.</p>
<pre><code class="lang-console">npm install b-tree</code></pre>
<h2>B-Tree Properties</h2>
<p>TK: Unique keys, but duplicate keys are super easy to fake with a simple recipe.</p>
<h2>Creating a B-Tree</h2>
<p>You must create the b‑tree  object first, specifying the size of the inner
branch pages as a count of child pages, and the size of the leaf pages as a
count of stored records.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">openOrCreate</span> <span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">check</span> <span class="o">=</span> <span class="nx">validator</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">strata</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Strata</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="p">{</span> <span class="nx">leafSize</span><span class="o">:</span> <span class="mi">1024</span><span class="p">,</span> <span class="nx">branchSize</span><span class="o">:</span> <span class="mi">1024</span> <span class="p">});</span>

  <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s1">&#39;ENOENT&#39;</span><span class="p">)</span> <span class="nx">strata</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">check</span><span class="p">(</span><span class="nx">done</span><span class="p">));</span>
    <span class="k">else</span> <span class="nx">strata</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">check</span><span class="p">(</span><span class="nx">done</span><span class="p">));</span>
  <span class="p">})</span>

  <span class="kd">function</span> <span class="nx">done</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">strata</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">openOrCreate</span><span class="p">(</span><span class="s1">&#39;/home/alan/strata&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">strata</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>

  <span class="c1">// Do something with an open b‑tree...</span>
<span class="p">});</span>
</pre></div>
</code></pre>
<p>Properties to the constructor...</p>
<h3><code>new Strata(location[, options])</code>.</h3>
<p>Constructs a new b-tree that stores its files in the directory provided by
<code>location</code>. It does not open or close the b‑tree.</p>
<h4><code>options</code></h4>
<p><code>new Strata()</code> takes an optional options object as its second argument; the
following properties are accepted:</p>
<ul>
<li><code>extractor</code>: A function that extracts the key from the record.</li>
<li><code>comparator</code>: A function that is used to compare keys.</li>
<li><code>leafSize</code>: The maximum size in records of a leaf page before it is it split.</li>
<li><code>branchSize</code>: The maximum size in child pages of a branch page before it is
split.</li>
<li><code>checksum</code>: A cryptographic algorithm to use as a hash, or a checksum
function to validate each line in a leaf page, and the contents of a branch
page.</li>
</ul>
<h3><code>strata.open(callback)</code></h3>
<p>Opens the b-tree.</p>
<h3><code>strata.open(callback)</code></h3>
<p>Creates a new, empty b-tree. It will raise an exception if there is <em>anything</em>
in the location directory.</p>
<h2>Searching and Editing</h2>
<p>You search and edit the b‑ separate from editing it.</p>
<h3>Searching the B‑Tree</h3>
<p>With Strata you either create read-only iterator, or a read/write mutator. The
mutator is a superset of the iterator so let&#39;s start there.</p>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">hasKey</span> <span class="p">(</span><span class="nx">strata</span><span class="p">,</span> <span class="nx">sought</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">check</span> <span class="o">=</span> <span class="nx">validator</span><span class="p">(</span><span class="nx">callback</span><span class="p">),</span> <span class="nx">found</span><span class="p">;</span>

  <span class="nx">strata</span><span class="p">.</span><span class="nx">iterator</span><span class="p">(</span><span class="nx">sought</span><span class="p">,</span> <span class="nx">check</span><span class="p">(</span><span class="nx">atLeaf</span><span class="p">));</span>

  <span class="kd">function</span> <span class="nx">atLeaf</span> <span class="p">(</span><span class="nx">cursor</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">found</span> <span class="o">=</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">cursor</span><span class="p">.</span><span class="nx">unlock</span><span class="p">();</span>
    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">found</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">hasKey</span><span class="p">(</span><span class="nx">strata</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">exists</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;I found it.&#39;</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</code></pre>
<p>In the above, we create a read-only <code>Cursor</code> using the <code>Strata.iterator</code>
function. That returns an iterator that holds a shared lock on the leaf page
that either contains the records for the given key, or else would contain the
record for the given key if it existed in the leaf page. The <code>Cursor</code> says that
the record is here, or it should go here.</p>
<p>If the <code>Cursor.index</code> property is zero or more, it is the index of the record in
the leaf page. If the <code>Cursor.index</code> property is less than zero, then it&#39;s
compliment is the index of where the record should go in the leaf page.</p>
<p>In the <code>hasKey</code> function above we simply return whether or not the record exists
based on the cursor index.</p>
<h3>Scanning the B‑Tree</h3>
<pre><code class="lang-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">range</span> <span class="p">(</span><span class="nx">strata</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">stop</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">check</span> <span class="o">=</span> <span class="nx">validator</span><span class="p">(</span><span class="nx">callback</span><span class="p">),</span> <span class="nx">found</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="nx">strata</span><span class="p">.</span><span class="nx">iterator</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">check</span><span class="p">(</span><span class="nx">atLeaf</span><span class="p">));</span>

  <span class="kd">function</span> <span class="nx">atLeaf</span> <span class="p">(</span><span class="nx">cursor</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fetch</span><span class="p">(</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">~</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">index</span> <span class="o">:</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">index</span><span class="p">);</span>

    <span class="kd">function</span> <span class="nx">fetch</span> <span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cursor</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">check</span><span class="p">(</span><span class="nx">push</span><span class="p">));</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">cursor</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">check</span><span class="p">(</span><span class="nx">advanced</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">push</span> <span class="p">(</span><span class="nx">record</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">record</span> <span class="o">&lt;</span> <span class="nx">stop</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">found</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">record</span><span class="p">);</span>
        <span class="nx">fetch</span><span class="p">(</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">done</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">advanced</span> <span class="p">(</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">success</span><span class="p">)</span> <span class="nx">done</span><span class="p">();</span>
      <span class="k">else</span> <span class="nx">fetch</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">done</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">cursor</span><span class="p">.</span><span class="nx">unlock</span><span class="p">();</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">found</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">range</span><span class="p">(</span><span class="nx">strata</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">found</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">found</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</code></pre>
</div>

</div></body>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-20388260-3', 'bigeasy.github.io');
ga('send', 'pageview');
</script>
</html>
